<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>GUMSPIN</title>

    <meta name="robots" content="index, follow" />
    <meta name="description" content="Let's always be stupid, forever!">
    <meta name="author" content="Volker Wieban">
    <meta name="keywords" content="leapmotion, gum, spin, kelly, al bundy">

    <meta property="og:title" content="GUMSPIN!">
    <meta property="og:image" content="kelly.jpg">

    <link rel="canonical" href="http://gumspin.hpcodecraft.me">

    <link href='http://fonts.googleapis.com/css?family=Coda+Caption:800|Playfair+Display+SC:400,900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/gumspin.css">
  </head>
  <body>
    <div class="page">
      <h1>
        <div class="font-gum shadow">gum</div>
        <div class="font-spin shadow">spin</div>
      </h1>
      <div class="player">Name for highscores: <input type="text" id="highscore-name" maxlength="100" value="Anonymous"></div>
      <div class="kelly">
        <canvas id="canvas" width="480" height="320"></canvas>
      </div>
      <h2 class="spin-counter">You spun the gum <strong>0</strong> times.</h2>
      <table>
        <tr>
          <td>Chain</td>
          <td class="chain number">0</td>
          <td>Score</td>
          <td class="score number">0</td>
          <td><button class="reset-score">reset</button></td>
        </tr>
        <tr>
          <td>Longest Chain</td>
          <td class="longest-chain number">-</td>
          <td>Highscore</td>
          <td class="highscore number">-</td>
          <td><button class="reset-highscore">reset</button></td>
        </tr>
      </table>
      <p class="instructions"><em>Hint: Draw circles on Kelly with your mouse.</em></p>

      <div class="leapmotion-status">
        <label></label>
      </div>
    </div>

    <div class="page highscore">
      <h1 class="font-gum shadow">Top highscores</h1>
      <div id="highscore-table"></div>
    </div>

    <footer>
      <div class="social">
        <!-- AddThis Button BEGIN -->
        <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
        </div>
        <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52a5f882312d4fc7"></script>
        <!-- AddThis Button END -->
      </div>
      made by <a href="http://hpcodecraft.me">hpcodecraft</a> in 2013
    </footer>

    <script>
    var kelly = document.querySelector('.kelly'),
        frame = 0,
        timeout = null,
        spinCounter = 0,
        speed = 50,
        clockwise = true,
        animationRunning = false,
        player = localStorage.getItem('player') || 'Anonymous',
        device = 'Mouse';


    function animateKelly() {
      clearTimeout(chainTimeout);

      animationRunning = true;

      var theFrame;

      if(clockwise) theFrame = frame;
      else {
        theFrame = 10 - frame;
        if(theFrame == 10) theFrame = 0;
      }

      kelly.style.backgroundPosition = "0 "+(-theFrame*330)+"px";
      frame++;
      if(frame < 10 ) timeout = setTimeout(animateKelly, speed);
      else timeout = setTimeout(function() {
        kelly.style.backgroundPosition = "0 0";
        frame = 0;
        spinCounter++;
        var text = 'You spun the gum <strong>'+spinCounter+'</strong> ';
        if(spinCounter == 1) text+='time.';
        else text+='times.';
        document.querySelector('.spin-counter').innerHTML = text;
        animationRunning = false;

        // chain handling
        incrementChain();
        extendChain();

        updateScore();
      }, speed);
    }
    </script>

    <script src="js/leap.js"></script>
    <script src="js/gumspin-leapmotion.js"></script>
    <script src="js/gumspin-mouse.js"></script>

    <script>
      var chainCount = 0,
          chainTimeout,
          chainTimeoutDuration = 750,
          chainActive = false,
          score = 0,
          longestChain = localStorage.getItem('longestChain') || 0,
          highScore = localStorage.getItem('highScore') || 0;

      function breakChain() {
        chainCount = 0;
        chainActive = false;

        document.querySelector('.chain').innerHTML = chainCount;

        var txt = document.createElement('div');
            txt.innerHTML = 'too slow, chain broken!';
            txt.className = 'floater';
        kelly.appendChild(txt);

        if(score == highScore) submitHighscore();
      }

      function extendChain() {
        chainTimeout = setTimeout( breakChain, chainTimeoutDuration );
      }

      function incrementChain() {
        chainCount++;
        document.querySelector('.chain').innerHTML = chainCount;

        if(chainCount > longestChain) {
          longestChain = chainCount;
          localStorage.setItem('longestChain', longestChain);
          document.querySelector('.longest-chain').innerHTML = longestChain;
        }
      }

      function updateScore() {
        var digits = document.querySelectorAll('.floater');
        for(var i = 0; i < digits.length; i++) {
          digits[i].parentNode.removeChild(digits[i]);
        }

        var add = chainCount*1;
        score+= add;
        document.querySelector('.score').innerHTML = score;

        var digit = document.createElement('div');
            digit.innerHTML = '+'+add;
            digit.className = 'floater';
        kelly.appendChild(digit);

        if(score > highScore) {
          highScore = score;
          localStorage.setItem('highScore', highScore);
          document.querySelector('.highscore').innerHTML = highScore;
        }
      }

      function setPlayer() {
        localStorage.setItem('player', this.value);
      }

      function initUI() {
        document.querySelector('#highscore-name').value = player;
        document.querySelector('#highscore-name').oninput = setPlayer;
        document.querySelector('#highscore-name').onpaste = setPlayer;

        document.querySelector('.longest-chain').innerHTML = longestChain;
        document.querySelector('.highscore').innerHTML = highScore;

        document.querySelector('.reset-score').onclick = function() {
          spinCounter = 0;
          document.querySelector('.spin-counter').innerHTML = 'You spun the gum <strong>'+spinCounter+'</strong> times.';

          chainCount = 0;
          document.querySelector('.chain').innerHTML = chainCount;

          score = 0;
          document.querySelector('.score').innerHTML = score;
        }

        document.querySelector('.reset-highscore').onclick = function() {
          if(confirm('Do you really want to reset your longest chain and highscore?')) {
            longestChain = 0;
            localStorage.setItem('longestChain', longestChain);
            document.querySelector('.longest-chain').innerHTML = chainCount;

            highScore = 0;
            localStorage.setItem('highScore', highScore);
            document.querySelector('.highscore').innerHTML = highScore;
          }
        }
      }

      initUI();


      // highscore handling
      var http = new XMLHttpRequest();

      function submitHighscore() {
        var data = 'name='+player+'&score='+highScore+'&chain='+longestChain+'&device='+device;
        http.open('POST', 'submithighscore.php', true);
        http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        http.send(data);
      }

      function listHighscore() {
        http.open('GET', 'listhighscore.php');
        http.onreadystatechange = function(){
          if(http.readyState == 4 && http.status == 200) {
            var highscores  = JSON.parse(http.responseText),
                table       = document.createElement('table'),
                tableHead   = document.createElement('tr'),
                headCells = [
                  document.createElement('th'),
                  document.createElement('th'),
                  document.createElement('th'),
                  document.createElement('th'),
                  document.createElement('th')
                ];

            headCells[0].innerHTML = '&nbsp;';
            headCells[1].innerHTML = 'Name';
            headCells[2].innerHTML = 'Score';
            headCells[3].innerHTML = 'Chain';
            headCells[4].innerHTML = 'Device';

            for( var i in headCells ) tableHead.appendChild(headCells[i]);
            table.appendChild(tableHead);

            for(var i in highscores) {
              var entry       = highscores[i],
                  row         = document.createElement('tr'),
                  cellplace   = document.createElement('td'),
                  cellname    = document.createElement('td'),
                  cellscore   = document.createElement('td'),
                  cellchain   = document.createElement('td'),
                  celldevice  = document.createElement('td');

              cellplace.innerHTML = (+i+1)+".";
              row.appendChild(cellplace);

              cellname.innerHTML = entry.name;
              row.appendChild(cellname);

              cellscore.innerHTML = entry.score;
              row.appendChild(cellscore);

              cellchain.innerHTML = entry.chain;
              row.appendChild(cellchain);

              celldevice.innerHTML = entry.device;
              row.appendChild(celldevice);

              table.appendChild(row);
            }

            var tableContainer = document.querySelector('#highscore-table');
            while( tableContainer.hasChildNodes() ){
              tableContainer.removeChild(tableContainer.lastChild);
            }
            tableContainer.appendChild(table);
          }
        }
        http.send()
      }

      setInterval(listHighscore, 60000); // update highscore list every minute
      listHighscore();
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-24332236-9', 'gumspin.hpcodecraft.me');
      ga('send', 'pageview');

    </script>
  </body>
</html>
